# -*- coding: utf-8 -*-
"""Fare_Prediction.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1R8k27vXkOaQZ7r4nsg894oDq1UrIJ-0b

# **Check and Copy Data**
"""

import os
os.listdir("/content")

import pandas as pd

# Read cleaned dataset
df = pd.read_csv("/content/yellow_tripdata_2016-03_cleaned.csv")

# Quick check
df.head()
df.info()

df4 = df.copy()
print(df4.shape)
print(df4.columns)

"""# **Install + Import XGBoost**"""

!pip -q install xgboost

import pandas as pd
import numpy as np

from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import xgboost as xgb
from xgboost import XGBRegressor

"""# **Preprocessing**

**STEP 1 : Convert Date & Time Columns into a Single Datetime Column**
"""

df4['pickup_datetime'] = pd.to_datetime(df4['pickup_date'] + " " + df4['pickup_time'], errors='coerce')
df4['dropoff_datetime'] = pd.to_datetime(df4['dropoff_date'] + " " + df4['dropoff_time'], errors='coerce')

"""**STEP 2 : Extract Time Features (Feature Engineering)**"""

df4['pickup_hour'] = df4['pickup_datetime'].dt.hour
df4['pickup_day'] = df4['pickup_datetime'].dt.day
df4['pickup_month'] = df4['pickup_datetime'].dt.month
df4['pickup_year'] = df4['pickup_datetime'].dt.year
df4['pickup_dayofweek'] = df4['pickup_datetime'].dt.dayofweek

"""**Step 3 : Define Peak Hours**"""

# Define peak hours (example: 7–9 AM and 16–19 PM)
df4['is_peak_hour'] = df4['pickup_hour'].apply(
    lambda x: 1 if (7 <= x <= 9) or (16 <= x <= 19) else 0
)
# Add peak hour surcharge (simulate higher price during peak hours)
df4['peak_surcharge'] = df4['is_peak_hour'] * 2.5

"""**Step 4 : Define Target**"""

df4['fare_amount_adjusted'] = df4['fare_amount'] + df4['peak_surcharge']

"""**STEP 5 : Remove Impossible Values (Negative or Zero Distance/Fare)**"""

df4 = df4[df4['fare_amount'] > 0]
df4 = df4[df4['trip_distance'] > 0]

"""**STEP 6 :Fix Outliers Using IQR Method**"""

import numpy as np

def remove_outliers_iqr(df, col):
    Q1 = df4[col].quantile(0.25)
    Q3 = df4[col].quantile(0.75)
    IQR = Q3 - Q1
    lower = Q1 - 1.5 * IQR
    upper = Q3 + 1.5 * IQR
    return df4[(df4[col] >= lower) & (df4[col] <= upper)]

df4 = remove_outliers_iqr(df4, 'trip_distance')
df4 = remove_outliers_iqr(df4, 'fare_amount')
df4 = remove_outliers_iqr(df4, 'total_amount')

"""**STEP 7 : Select Features for Fare Prediction**"""

features = [
    'trip_distance',
    'pickup_longitude', 'pickup_latitude',
    'dropoff_longitude', 'dropoff_latitude',
    'pickup_hour', 'pickup_day',
    'pickup_month', 'pickup_dayofweek',
    'is_peak_hour'
]

X = df4[features]
y = df4['fare_amount_adjusted']

"""**Step 8: Split Train / Test**"""

from sklearn.model_selection import train_test_split

X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42
)

"""**Step 9 : Ensure All Features are Numeric Before Training**"""

# Create a safe copy to avoid SettingWithCopyWarning
X_train = X_train.copy()
X_test = X_test.copy()

# Convert all feature columns to numeric
for col in X_train.columns:
    X_train[col] = pd.to_numeric(X_train[col], errors='coerce')
    X_test[col] = pd.to_numeric(X_test[col], errors='coerce')

# Fill any remaining NaN values (caused by coercion)
X_train = X_train.fillna(0)
X_test = X_test.fillna(0)

"""# **Model Development and Evaluation**

**Step 1 : Train Regression Model (XGBoots)**
"""

xgb_model = XGBRegressor(
    n_estimators=300,
    learning_rate=0.1,
    max_depth=6,
    subsample=0.8,
    colsample_bytree=0.8,
    objective='reg:squarederror',
    random_state=42
)

xgb_model.fit(X_train, y_train)

"""Step 2 : Evaluate Model"""

from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score
import numpy as np

y_pred = xgb_model.predict(X_test)

print("MAE:", mean_absolute_error(y_test, y_pred))
print("RMSE:", np.sqrt(mean_squared_error(y_test, y_pred)))
print("R2:", r2_score(y_test, y_pred))

"""# **Model Evaluation Result - Fare Prediction**

**Actual vs Predicted Plot**
"""

import matplotlib.pyplot as plt

plt.figure(figsize=(6,6))
plt.scatter(y_test, y_pred, alpha=0.4)
plt.plot([y_test.min(), y_test.max()],
         [y_test.min(), y_test.max()],
         'r--')
plt.xlabel("Actual Fare Amount")
plt.ylabel("Predicted Fare Amount")
plt.title("Actual vs Predicted Fare Amount")
plt.show()

"""**Residuals Plot**"""

residuals = y_test - y_pred

plt.figure(figsize=(6,4))
plt.scatter(y_pred, residuals, alpha=0.4)
plt.axhline(0, color='red', linestyle='--')
plt.xlabel("Predicted Fare Amount")
plt.ylabel("Residuals (Actual - Predicted)")
plt.title("Residuals vs Predicted")
plt.show()

"""**Error Distribution (Histogram)**"""

plt.figure(figsize=(6,4))
plt.hist(residuals, bins=50)
plt.xlabel("Prediction Error")
plt.ylabel("Frequency")
plt.title("Distribution of Prediction Errors")
plt.show()

"""# **Testing the Fare Prediction Model Using Peak and Non-Peak Scenarios**"""

peak_input = pd.DataFrame([{
    "trip_distance": 3000,          # meters
    "pickup_longitude": -73.9855,
    "pickup_latitude": 40.7580,
    "dropoff_longitude": -73.9819,
    "dropoff_latitude": 40.7681,
    "pickup_hour": 18,              # Peak hour
    "pickup_day": 10,
    "pickup_month": 5,
    "pickup_dayofweek": 2,
    "is_peak_hour": 1
}])

peak_prediction = xgb_model.predict(peak_input)
print("Predicted Fare (Peak Hour):", peak_prediction[0])

non_peak_input = pd.DataFrame([{
    "trip_distance": 3000,          # meters
    "pickup_longitude": -73.9855,
    "pickup_latitude": 40.7580,
    "dropoff_longitude": -73.9819,
    "dropoff_latitude": 40.7681,
    "pickup_hour": 11,              # Non-peak hour
    "pickup_day": 10,
    "pickup_month": 5,
    "pickup_dayofweek": 2,
    "is_peak_hour": 0
}])

non_peak_prediction = xgb_model.predict(non_peak_input)
print("Predicted Fare (Non-Peak Hour):", non_peak_prediction[0])